{% extends "base.html" %}

{% block title_row %}{% endblock %}
{% block title_ruler %}{% endblock %}

{% block media %}
  <link rel="alternate" type="application/atom+xml" href="{{ url('blog_atom') }}" title="Atom Blog Feed">
  <link rel="alternate" type="application/rss+xml" href="{{ url('blog_rss') }}" title="RSS Blog Feed">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  {% compress css %}
    <link rel="stylesheet" href="{{ static('blog-modern.css') }}">
  {% endcompress %}
{% endblock %}

{% block js_media %}
  {% include "blog/media-js.html" %}
{% endblock %}

{% block body %}
    {% set view_mode = request.GET.view | default('grid') %}
    <div class="magazine-layout" id="magazine-layout" data-view="{{ view_mode }}">
  <!-- Main -->
  <main class="magazine-main" id="magazine-main">
    <!-- Top bar -->
    <div class="magazine-topbar">

      <form class="magazine-search" method="get" action="{{ url('blog_modern_list') }}">
        {% if tags %}
        <select name="tag" class="search-type-select" id="search-type-select" aria-label="{{ _('Search scope') }}">
          <option value="" {% if not request.GET.tag %}selected{% endif %}>{{ _('Tags') }}</option>
          {% for tag in tags %}
            <option value="{{ tag.slug }}" {% if request.GET.tag == tag.slug %}selected{% endif %}>{{ tag.name }}</option>
          {% endfor %}
        </select>
        {% endif %}
        <div class="search-input-wrapper">
          <button type="submit" class="search-icon" aria-label="{{ _('Search') }}">
            <i class="fa fa-search" aria-hidden="true"></i>
          </button>
          <input type="text" name="q" id="blog-search-input"
                 placeholder="{{ _('Search articles...') }}"
                 class="search-input"
                 value="{{ request.GET.q | default('') }}"
                 aria-label="{{ _('Search articles') }}">
        </div>
        {% if request.GET.sort %}
          <input type="hidden" name="sort" value="{{ request.GET.sort }}">
        {% endif %}
      </form>

      <div class="magazine-controls">
        <div class="select-wrap">
          <label for="sort-select" class="sr-only">{{ _('Sort by') }}</label>
          <select id="sort-select" class="select">
            <option value="latest" {% if request.GET.sort == 'latest' or not request.GET.sort %}selected{% endif %}>{{ _('Latest') }}</option>
            <option value="top" {% if request.GET.sort == 'top' %}selected{% endif %}>{{ _('Top') }}</option>
            <option value="discussed" {% if request.GET.sort == 'discussed' %}selected{% endif %}>{{ _('Discussed') }}</option>
          </select>
        </div>

  

        {% if request.user.is_authenticated and perms.judge.manage_magazine_post %}
          <a href="{{ url('user_blog', request.user.username) }}" class="btn-top-bar">
            <i class="fa fa-user"></i><span>{{ _('My Posts') }}</span>
          </a>
          <a href="{{ url('blog_post_new') }}" class="btn-top-bar">
            <i class="fa fa-pencil"></i><span>{{ _('Write') }}</span>
          </a>
        {% endif %}
        {% if request.user.is_staff %}
          <a href="{{ url('admin:judge_blogpost_changelist') }}" class="btn-top-bar">
            <i class="fa fa-cog"></i><span>{{ _('Manage') }}</span>
          </a>
        {% endif %}
      </div>
    </div>

    <div id="magazine-feed"
         class="magazine-feed {% if view_mode == 'list' %}is-list{% endif %}"
         data-next-page="{% if page_obj.has_next() %}{{ url('blog_modern_list') }}?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if view_mode %}&view={{ view_mode }}{% endif %}{% endif %}">

      {% for post in posts %}
        {% if loop.first and post.sticky and not request.GET.q %}
          {# skip hero #}
        {% else %}
        <article class="magazine-card" id="post-{{ post.id }}" data-post-id="{{ post.id }}">
          <div class="card-header">
            <div class="card-badges">
              {% if post.sticky %}<span class="badge badge-pinned"><i class="fa fa-thumb-tack"></i></span>{% endif %}
              {% if not post.visible %}<span class="badge badge-draft"><i class="fa fa-eye-slash"></i></span>{% endif %}
              {% if post.global_post %}<span class="badge badge-global"><i class="fa fa-globe"></i></span>{% endif %}
            </div>
            <div class="card-date"><i class="fa fa-clock-o"></i>{{ relative_time(post.publish_on, abs=_('on {time}'), rel=_('{time}')) }}</div>
          </div>

          <h2 class="magazine-card-title">
            <a href="{{ url('blog_post_modern', post.id, post.slug) }}">{{ post.title }}</a>
          </h2>

          <div class="magazine-card-excerpt">
          {% cache 60 'post_modern_summary' post.id %}
              {{ post.summary|default(post.content, true)|truncatewords_html(50)|markdown('blog', 'svg', lazy_load=True)|reference|str|safe }}
          {% endcache %}
          {%- if post.summary -%}
              <p><a href="{{ url('blog_post', post.id, post.slug) }}">{{ _('Continue reading...') }}</a></p>
          {%- endif -%}
          </div>

          <div class="card-footer">
            <div class="card-author magazine-card-author">
              {% set authors = post.authors.all() %}
              {% if authors %}<i class="fa fa-user"></i>{{ link_users(authors) }}{% endif %}
            </div>
            
            {# Card tags #}
            {% if post.tags.exists() %}
            <div class="card-tags">
              {% for tag in post.tags.all() %}
                <a href="{{ url('blog_modern_list') }}?tag={{ tag.slug }}" class="post-tag">{{ tag.name }}</a>
              {% endfor %}
            </div>
            {% endif %}
            
            <div class="card-actions">
              {% set logged_in = request.user.is_authenticated %}
              {% set vote_info = post_votes[post.id] %}
              
              <div class="stat-item vote-stat" data-post-id="{{ post.id }}">
                <i class="fa fa-thumbs-up"></i>
                <span id="post-score-{{ post.id }}" 
                      title="{{ _('Total score:') }} {{ post.score }} ({{ vote_info.upvote_count }} {{ _('up') }}, {{ vote_info.downvote_count }} {{ _('down') }})"
                      data-toggle="tooltip">
                  {{ post.score }}
                </span>
                {% if logged_in %}
                  <div class="vote-buttons">
        <button class="vote-btn {% if post.vote_score == 1 %}voted{% endif %}"
          data-action="upvote"
          data-post-id="{{ post.id }}"
          onclick="blog_upvote({{ post.id }}); return false;"
          {% if post.vote_score != 0 %}disabled{% endif %}
          {% if post.vote_score == 1 %}aria-pressed="true"{% else %}aria-pressed="false"{% endif %}
          title="{{ _('Upvote') }}">
                      <i class="fa fa-arrow-up"></i>
                    </button>
        <button class="vote-btn {% if post.vote_score == -1 %}voted{% endif %}"
          data-action="downvote"
          data-post-id="{{ post.id }}"
          onclick="blog_downvote({{ post.id }}); return false;"
          {% if post.vote_score != 0 %}disabled{% endif %}
          {% if post.vote_score == -1 %}aria-pressed="true"{% else %}aria-pressed="false"{% endif %}
          title="{{ _('Downvote') }}">
                      <i class="fa fa-arrow-down"></i>
                    </button>
                  </div>
                {% endif %}
              </div>
              
              <span class="stat-item"
                    title="{{ _('View') }} {{ post_comment_counts[post.id] | default(0) }} {{ _('comments') }}">
                <i class="fa fa-comments"></i>
                <span>{{ post_comment_counts[post.id] | default(0) }}</span>
                <span class="stat-label">{{ _('comments') }}</span>
              </span>
            </div>
          </div>
        </article>
        {% endif %}
      {% endfor %}

      <template id="card-skeleton">
        <article class="magazine-card skeleton">
          <div class="skeleton-line w-40"></div>
          <div class="skeleton-line w-80 mt-2"></div>
          <div class="skeleton-line w-60 mt-2"></div>
          <div class="skeleton-footer">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-line w-30"></div>
          </div>
        </article>
      </template>
    </div>

    {% if page_obj.has_other_pages() %}
      <div class="magazine-pagination">
        {% include "list-pages.html" %}
      </div>
    {% endif %}
  </main>
</div>


{% endblock %}

{% block bodyend %}
  {{ super() }}
  {% if REQUIRE_JAX %}{% include "mathjax-load.html" %}{% endif %}
{% endblock %}
