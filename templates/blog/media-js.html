<script src="{{ static('libs/featherlight/featherlight.min.js') }}" type="text/javascript"></script>
{% compress js %}
    <script type="text/javascript">
        $(document).ready(function () {
            function ajax_vote_blog(url, id, delta, on_success) {
                return $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        id: id
                    },
                    success: function (data, textStatus, jqXHR) {
                        var score = $('#post-' + id + ' #post-score');

                        score.each(function() {
                            console.log($(this).text(parseInt($(this).text()) + delta));
                        });
                        if (typeof on_success !== 'undefined')
                            on_success();
                    },
                    error: function (data, textStatus, jqXHR) {
                        alert('Could not vote: ' + data.responseText);
                    }
                });
            }

            var get_$votes = function (id) {
                var $post = $('#post-' + id);
                return {
                    upvote1: $post.find('.upvote-link').first(),
                    downvote1: $post.find('.downvote-link').first(),
                    upvote2: $post.find('.upvote-link').last(),
                    downvote2: $post.find('.downvote-link').last(),
                };
            };

            window.blog_upvote = function (id) {
                ajax_vote_blog('{{ url('blog_upvote') }}', id, 1, function () {
                    var $votes = get_$votes(id);
                    if ($votes.downvote1.hasClass('voted'))
                        $votes.downvote1.removeClass('voted');
                    else
                        $votes.upvote1.addClass('voted');
                    if ($votes.downvote2.hasClass('voted'))
                        $votes.downvote2.removeClass('voted');
                    else
                        $votes.upvote2.addClass('voted');
                });
            };

            window.blog_downvote = function (id) {
                ajax_vote_blog('{{ url('blog_downvote') }}', id, -1, function () {
                    var $votes = get_$votes(id);
                    if ($votes.upvote1.hasClass('voted'))
                        $votes.upvote1.removeClass('voted');
                    else
                        $votes.downvote1.addClass('voted');
                    if ($votes.upvote2.hasClass('voted'))
                        $votes.upvote2.removeClass('voted');
                    else
                        $votes.downvote2.addClass('voted');
                });
            };

            $('votes-link').find('a[data-featherlight]').featherlight();
        });
    </script>
{% endcompress %}
