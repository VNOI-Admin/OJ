<script src="{{ static('libs/featherlight/featherlight.min.js') }}" type="text/javascript"></script>
{% compress js %}
    <script type="text/javascript">
        $(document).ready(function () {
            function ajax_vote(url, id, delta, on_success) {
                return $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        id: id
                    },
                    success: function (data, textStatus, jqXHR) {
                        // Update classic templates (#post-score inside #post-ID)
                        var score = $('#post-' + id + ' #post-score').first();
                        if (score.length) {
                            score.text(parseInt(score.text()) + delta);
                        }
                        // Update magazine templates (#post-score-ID)
                        var magScore = $('#post-score-' + id).first();
                        if (magScore.length) {
                            magScore.text(parseInt(magScore.text()) + delta);
                        }
                        if (typeof on_success !== 'undefined')
                            on_success();
                    },
                    error: function (data, textStatus, jqXHR) {
                        alert('Could not vote: ' + data.responseText);
                    }
                });
            }

            var get_$votes = function (id) {
                var $post = $('#post-' + id);
                return {
                    upvote: $post.find('.upvote-link').first(),
                    downvote: $post.find('.downvote-link').first(),
                };
            };

            window.blog_upvote = function (id) {
                ajax_vote('{{ url('blog_upvote') }}', id, 1, function () {
                    var $votes = get_$votes(id);
                    if ($votes.downvote.hasClass('voted'))
                        $votes.downvote.removeClass('voted');
                    else
                        $votes.upvote.addClass('voted');

                    // Update magazine card vote button if present
                    var $magazineCard = $('[data-post-id="' + id + '"]');
                    if ($magazineCard.length) {
                        var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                        var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                        var $voteCount = $magazineCard.find('#post-score-' + id);

                        // If not already upvoted, increment and set states
                        if (!$upvoteBtn.hasClass('voted')) {
                            $upvoteBtn.addClass('voted').attr('aria-pressed', 'true');
                            if ($voteCount.length) {
                                $voteCount.text(parseInt($voteCount.text()) + 1);
                            }
                        }
                        // Clear downvote state and disable both to prevent duplicate votes
                        $downvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                        $upvoteBtn.prop('disabled', true);
                        $downvoteBtn.prop('disabled', true);
                    }
                });
            };

            window.blog_downvote = function (id) {
                ajax_vote('{{ url('blog_downvote') }}', id, -1, function () {
                    var $votes = get_$votes(id);
                    if ($votes.upvote.hasClass('voted'))
                        $votes.upvote.removeClass('voted');
                    else
                        $votes.downvote.addClass('voted');

                    // Update magazine card vote button if present
                    var $magazineCard = $('[data-post-id="' + id + '"]');
                    if ($magazineCard.length) {
                        var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                        var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                        var $voteCount = $magazineCard.find('#post-score-' + id);

                        // If not already downvoted, decrement and set states
                        if (!$downvoteBtn.hasClass('voted')) {
                            $downvoteBtn.addClass('voted').attr('aria-pressed', 'true');
                            if ($voteCount.length) {
                                $voteCount.text(parseInt($voteCount.text()) - 1);
                            }
                        }
                        // Clear upvote state and disable both to prevent duplicate votes
                        $upvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                        $upvoteBtn.prop('disabled', true);
                        $downvoteBtn.prop('disabled', true);
                    }
                });
            };

            $('votes-link').find('a[data-featherlight]').featherlight();

            // Magazine layout modern features
            if (document.querySelector('.magazine-layout')) {

                // Search form handling
                const searchForm = document.querySelector('.magazine-search');
                const searchTypeSelect = document.querySelector('#search-type-select');

                // Handle tag selection change (immediate navigation)
                if (searchTypeSelect) {
                    searchTypeSelect.addEventListener('change', function() {
                        if (searchForm) {
                            searchForm.submit();
                        }
                    });
                }

                // Handle Enter key in search input
                const searchInput = document.querySelector('#blog-search-input');
                if (searchInput) {
                    searchInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (searchForm) {
                                searchForm.submit();
                            }
                        }
                    });
                }

                // Sort dropdown handler
                const sortSelect = document.querySelector('#sort-select');
                if (sortSelect) {
                    sortSelect.addEventListener('change', function(e) {
                        const sortValue = e.target.value;
                        const currentUrl = new URL(window.location.href);
                        if (sortValue && sortValue !== 'latest') {
                            currentUrl.searchParams.set('sort', sortValue);
                        } else {
                            currentUrl.searchParams.delete('sort');
                        }
                        currentUrl.searchParams.delete('page');
                        window.location.href = currentUrl.toString();
                    });
                }
            }
        });
    </script>
{% endcompress %}
