<script src="{{ static('libs/featherlight/featherlight.min.js') }}" type="text/javascript"></script>
{% compress js %}
    <script type="text/javascript">
        $(document).ready(function () {
            // Track ongoing vote requests to prevent double-voting
            var votingInProgress = {};
            
            function ajax_vote(url, id, delta, on_success) {
                // Prevent multiple simultaneous votes on the same post
                if (votingInProgress[id]) {
                    return;
                }
                
                votingInProgress[id] = true;
                
                return $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        id: id
                    },
                    success: function (data, textStatus, jqXHR) {
                        // Parse response to determine action
                        var action = data.trim(); // 'success', 'unvoted', or 'switched'
                        
                        if (typeof on_success !== 'undefined') {
                            on_success(action);
                        }
                    },
                    error: function (data, textStatus, jqXHR) {
                        alert('Could not vote: ' + data.responseText);
                    },
                    complete: function() {
                        // Allow voting again after request completes
                        votingInProgress[id] = false;
                    }
                });
            }

            var get_$votes = function (id) {
                // Find ALL vote buttons for this post ID
                var upvotes = $('.upvote-link').filter(function() {
                    var onclick = $(this).attr('onclick');
                    return onclick && onclick.includes('(' + id + ')');
                });
                
                var downvotes = $('.downvote-link').filter(function() {
                    var onclick = $(this).attr('onclick');
                    return onclick && onclick.includes('(' + id + ')');
                });
                
                // Also check for votes within post container
                var $post = $('#post-' + id);
                if ($post.length) {
                    upvotes = upvotes.add($post.find('.upvote-link'));
                    downvotes = downvotes.add($post.find('.downvote-link'));
                }
                
                return {
                    upvote: upvotes,
                    downvote: downvotes,
                };
            };

            window.blog_upvote = function (id) {
                // Prevent voting if already in progress
                if (votingInProgress[id]) {
                    return;
                }
                
                var $votes = get_$votes(id);
                var $magazineCard = $('[data-post-id="' + id + '"]');
                
                var wasUpvoted = $votes.upvote.hasClass('voted');
                var wasDownvoted = $votes.downvote.hasClass('voted');
                
                if ($magazineCard.length) {
                    var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                    var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                    if ($upvoteBtn.length && $upvoteBtn.hasClass('voted')) {
                        wasUpvoted = true;
                    }
                    if ($downvoteBtn.length && $downvoteBtn.hasClass('voted')) {
                        wasDownvoted = true;
                    }
                }
                
                $votes.upvote.prop('disabled', true);
                $votes.downvote.prop('disabled', true);
                
                if ($magazineCard.length) {
                    var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                    var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                    $upvoteBtn.prop('disabled', true);
                    $downvoteBtn.prop('disabled', true);
                }
                
                ajax_vote('{{ url('blog_upvote') }}', id, 1, function (action) {
                    var scoreSelectors = [
                        '#post-' + id + ' #post-score',
                        '#post-score-' + id,
                        '#post-score',
                        '#post-score-inline'
                    ];
                    
                    scoreSelectors.forEach(function(selector) {
                        var $score = $(selector);
                        if ($score.length) {
                            var currentScore = parseInt($score.text()) || 0;
                            if (action === 'unvoted') {
                                if (wasUpvoted) {
                                    $score.text(currentScore - 1);
                                } 
                                else if (wasDownvoted) {
                                    $score.text(currentScore + 1);
                                }
                            } else {
                                $score.text(currentScore + 1);
                            }
                        }
                    });
                    
                    if (action === 'unvoted') {
                        $votes.upvote.removeClass('voted');
                        $votes.downvote.removeClass('voted');
                    } else {
                        $votes.upvote.addClass('voted');
                        $votes.downvote.removeClass('voted');
                    }

                    if ($magazineCard.length) {
                        var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                        var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');

                        if (action === 'unvoted') {
                            $upvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                            $downvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                        } else {
                            $upvoteBtn.addClass('voted').attr('aria-pressed', 'true');
                            $downvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                        }
                        
                        $upvoteBtn.prop('disabled', false);
                        $downvoteBtn.prop('disabled', false);
                    }
                    
                    $votes.upvote.prop('disabled', false);
                    $votes.downvote.prop('disabled', false);
                });
            };

            window.blog_downvote = function (id) {
                if (votingInProgress[id]) {
                    return;
                }
                
                var $votes = get_$votes(id);
                var $magazineCard = $('[data-post-id="' + id + '"]');
                
                var wasUpvoted = $votes.upvote.hasClass('voted');
                var wasDownvoted = $votes.downvote.hasClass('voted');
                
                if ($magazineCard.length) {
                    var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                    var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                    if ($upvoteBtn.length && $upvoteBtn.hasClass('voted')) {
                        wasUpvoted = true;
                    }
                    if ($downvoteBtn.length && $downvoteBtn.hasClass('voted')) {
                        wasDownvoted = true;
                    }
                }
                
                $votes.upvote.prop('disabled', true);
                $votes.downvote.prop('disabled', true);
                
                if ($magazineCard.length) {
                    var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');
                    var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                    $upvoteBtn.prop('disabled', true);
                    $downvoteBtn.prop('disabled', true);
                }
                
                ajax_vote('{{ url('blog_downvote') }}', id, -1, function (action) {
                    var scoreSelectors = [
                        '#post-' + id + ' #post-score',
                        '#post-score-' + id,
                        '#post-score',
                        '#post-score-inline'
                    ];
                    
                    scoreSelectors.forEach(function(selector) {
                        var $score = $(selector);
                        if ($score.length) {
                            var currentScore = parseInt($score.text()) || 0;
                            if (action === 'unvoted') {
                                if (wasDownvoted) {
                                    $score.text(currentScore + 1);
                                } 
                                else if (wasUpvoted) {
                                    $score.text(currentScore - 1);
                                }
                            } else {
                                $score.text(currentScore - 1);
                            }
                        }
                    });
                    
                    if (action === 'unvoted') {
                        $votes.upvote.removeClass('voted');
                        $votes.downvote.removeClass('voted');
                    } else {
                        $votes.downvote.addClass('voted');
                        $votes.upvote.removeClass('voted');
                    }

                    if ($magazineCard.length) {
                        var $downvoteBtn = $magazineCard.find('[data-action="downvote"]');
                        var $upvoteBtn = $magazineCard.find('[data-action="upvote"]');

                        if (action === 'unvoted') {
                            $upvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                            $downvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                        } else {
                            $downvoteBtn.addClass('voted').attr('aria-pressed', 'true');
                            $upvoteBtn.removeClass('voted').attr('aria-pressed', 'false');
                        }
                        
                        $upvoteBtn.prop('disabled', false);
                        $downvoteBtn.prop('disabled', false);
                    }
                    
                    $votes.upvote.prop('disabled', false);
                    $votes.downvote.prop('disabled', false);
                });
            };

            $('votes-link').find('a[data-featherlight]').featherlight();

            if (document.querySelector('.magazine-layout')) {
                const sidebarToggle = document.querySelector('.sidebar-toggle');
                const sidebar = document.querySelector('.magazine-sidebar');
                
                if (sidebarToggle && sidebar) {
                    sidebarToggle.addEventListener('click', function() {
                        sidebar.classList.toggle('show');
                    });

                    document.addEventListener('click', function(e) {
                        if (window.innerWidth <= 968) {
                            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target) && sidebar.classList.contains('show')) {
                                sidebar.classList.remove('show');
                            }
                        }
                    });
                }

                const searchInput = document.querySelector('#blog-search-input');
                let searchTimeout;
                
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(function() {
                            const searchValue = e.target.value.trim();
                            const currentUrl = new URL(window.location.href);
                            if (searchValue) {
                                currentUrl.searchParams.set('q', searchValue);
                            } else {
                                currentUrl.searchParams.delete('q');
                            }
                            currentUrl.searchParams.delete('page');
                            window.location.href = currentUrl.toString();
                        }, 800);
                    });
                }

                const sortSelect = document.querySelector('#sort-select');
                if (sortSelect) {
                    sortSelect.addEventListener('change', function(e) {
                        const sortValue = e.target.value;
                        const currentUrl = new URL(window.location.href);
                        if (sortValue && sortValue !== 'latest') {
                            currentUrl.searchParams.set('sort', sortValue);
                        } else {
                            currentUrl.searchParams.delete('sort');
                        }
                        currentUrl.searchParams.delete('page');
                        window.location.href = currentUrl.toString();
                    });
                }

                document.querySelectorAll('.action-btn[data-action="upvote"], .vote-btn[data-action="upvote"]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const postId = this.getAttribute('data-post-id');
                        if (postId && !this.disabled) {
                            window.blog_upvote(postId);
                        }
                    });
                });

                document.querySelectorAll('.action-btn[data-action="downvote"], .vote-btn[data-action="downvote"]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const postId = this.getAttribute('data-post-id');
                        if (postId && !this.disabled) {
                            window.blog_downvote(postId);
                        }
                    });
                });

            }
        });
    </script>
{% endcompress %}
